{% toc %}

### AgregateFolder

AgregateFolder - папка имеет одноименное название с агрегатом.

В папке агрегата содержатся папки с реализацией конкретных фич(далее FeatureFolder), см. скриншот 1.

![img.png](img.png)

*Скриншот 1. Агрегат Persons и две FeatureFolder CreatePerson и DeletePerson.*

### FeatureFolder

FeatureFolder - содержит модули, описывающие только данную фичу, где фича - это некоторая функциональность,

например, создание пользователя.

#### Содержимое FeatureFolder

FeatureFolder могут содержать:

* Команду;

* Запрос;

* Обработчик команды(запроса);

* Маппер для входных и выходных данных обработчика запроса;

* Класс конфигурации;

* Настройки фичи;

* Модули с бизнес логикой.

![img_1.png](img_1.png)

*Скриншот 2. FeatureFolder CreatePerson, команда CreatePersonCommand,
обработчик команды CreatePersonCommandHandler, маппер CreatePersonMapper.*

#### Структура папок внутри FeatureFolder

FeatureFolder может содержать следующие папки и классы:

* Entities. Cодержит модули, описывающие таблицы в базе данных;

* EntitiesViews. Cодержит модули, описывающие частичные представления таблиц или объединения таблиц базы

данных, например View в бд;

* BusinessRules. Cодержит модули и фабрики, описывающие бизнес правила. Не путать с валидацией.

Например, проверка возраста выдачи водительского удостоверения. Валидаторы проверяют, что число должно

быть неотрицательное (больше 0). А бизнес правило, что число должно быть больше 18;

* Consts. Содержит модули, описывающие константы;

* Options. Cодержит модули, описывающие настройки фичи;

* Behaviors. Cодержит модули, описывающие пайплайны для данной фичи;

* Dto. Содержит модули, описывающие входные и выходные данные обработчика (кроме самой команды или

запроса Command/Query);

* Validation. Cодержит модули, описывающие валидацию входных данных обработчика;

* Папки реализующие работу с внешним сервисом, например SberbankApi. Папка с внешним сервисом содержит

свои Dto, Validation, Options и другие папки. Папка с внешним сервисом не может содержать класс с

конфигурацией. Папку с внешним сервисом можно делать общей, но только полностью все содержимое;

* Папки реализующие доменные обработчики (обработчики внутренних команд и запросов). Классы, которые

используются только в соответствующем доменном обработчике должны располагаться в папке доменного

обработчика. Но настройки и конфигурация может быть в FeatureFolder. Доменный обработчик может иметь

свою папку с Dto, но так же может ссылаться на Entities и на EntitiesViews.

* В корне FeatureFolder размещаем следующие классы: Mapper, Команда или запрос, Обработчик команды или

запроса, Класс конфигурации сервисов.

### Правила расположения разделов в appsettings.json

Для настроек, расположенных в FeatureFolder, ServiceFolder и AggregateSharedFolder разделы в appsettings
должны располагаться по правилу: \[NAMESPACE\_WITHOUT\_OPTIONS\_AND\_ROOT\] - в соответствии неймспейса
без учета папки Options, корневого неймспейса и имени класса настроек.
Например: класс настроек ChangeStatusOptions расположен в приложении Sales.ReturnClaim в таком неймспейсе
Sales.ReturnClaim.ReturnClaims.ChangeStatus.Options. Корневой неймспейс - Sales.ReturnClaim.

![img_2.png](img_2.png)  Следовательно раздел для данного класса настроек должен располагаться в **ReturnClaims:ChangeStatus**.

![img_3.png](img_3.png)  Для настроек, расположенных в **RootSharedFolder** разделы в appsettings должны располагаться по правилу: '**Shared:\[CLASSNAME\_WITHOUT\_OPTIONS\_SUFFIX\]**'. Например: класс настроек **ApplicationOptions** расположен в

приложении **Sales.ReturnClaim** в таком неймспейсе **Sales.ReturnClaim.ReturnClaims.Shared.Options**. Корневой

неймспейс - **Sales.ReturnClaim**.

![img_4.png](img_4.png)  Следовательно раздел для данного класса настроек должен располагаться в **Shared:Application**.

![img_5.png](img_5.png)

> Папки Dto и Validation нельзя делать общие. Они всегда служат только одному обработчику, даже если нужно
>
> дублировать много кода.

> Для валидации можно переносить выражения в папку Consts(например регулярные выражения для email, url,
>
> длину строки, максимальное число и тп.). Константы уже можно делать общие.

> Класс Mapper относится непосредственно к Dto, поэтому его тоже нельзя делать общим.

> Входные данные необходимо замаппить перед тем, как отдавать на обработку другим объектам. Например:
>
> PersontDto → Person

> Выходные данные можно иногда не маппить в Dto. Н-р: запрос GetPersonsQuery отдает список PersonItem
>
> (данный класс является View). Данный список объектов можно не маппить в PersonItemDto, если класс
>
> PersonItem не является рассшаренным, иначе нужно обязательно маппить. Идея такая что все выходные
>
> данные должны быть описаны уникальными классами. Это необходимо, чтобы можно было делать
>
> рефакторинг и понимать, где какие классы и их свойства нужны для каких эндпоинтов.

### Папка Shared

Папка Shared внутри агрегата содержит общие модули для фич одного агрегата.

Папка Shared за пределами агрегата - содержит общие модули для все фич всех агрегатов.

![img_6.png](img_6.png)

*Скриншот 3. Папка Shared для Persons.*

### Правила расшаривания модулей

Модуль переносится полностью со всей структурой папок, как если бы он находился внутри фичи или агрегата.

Например, необходимо расшарить модуль SomeEntity1.cs, находящиеся в FeatureFolder1 для другой фичи

FeatureFolder2 такого же агрегата:

![img_7.png](img_7.png)

*Скриншот 4. SomeEntity1.cs нужно сделать общим для агрегата AgrefateFolder1.*

После рефакторинга структура модулей будет следующая:

![img_8.png](img_8.png)

*Скриншот 5. SomeEntity1.cs стал общим для агрегата AgrefateFolder1 и его фич.*

Если же SomeEntity1.cs необходимо сделать общим для фичи FeatureFolder3 другого агрегата, то структура модулей будет следующая:

![img_9.png](img_9.png)

*Скриншот 6. SomeEntity1.cs стал общим для агрегатов AgrefateFolder1 и AgrefateFolder2.*

> Заметьте, что модуль SomeEntity1.cs в этом случае переносится вместе с папкой AgregateFolder1.

> Если необходимо расшарить модуль доменного обработчика (обработчик внутренней команды или запроса)
>
> между доменными обработчиками, то нужно просто модуль перенести в FeatureFolder.

> Если необходимо расшарить модуль доменного обработчика (обработчик внутренней команды или запроса)
>
> между другими фичами и агрегатами, то необходимо переносить без уровня папки с названием доменного
>
> обработчика.

> Если доменный обработчик расшаривается полностью, то необходимо учитывать связи с Dto - их не должно
>
> быть, так как Dto классы нельзя расшаривать. Такое же правильно относится к EntitesViews, если данные
>
> классы являются выходными данными.